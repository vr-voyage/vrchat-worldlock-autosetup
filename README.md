# About

This tool allows you to setup world-locked items on your avatar,
meaning that placed items won't move until you put them away.
While plenty of documentation exist on how to setup items that way,
the process is still tedious, so I made a tool that :

* Setup the hierarchy.
* Create the animations.
* Setup the FX animator (creating it if it's doesn't exist).
* Setup the SDK3 menu parameters.
* Add the SDK3 menu buttons.

The tool will copy the avatar, and any modified asset, and will
perform modifications on these copies only.

Still, as always, backup the items and avatars you'll use with
this tool.
I only tested it on MY avatars.
So far, so long, no problems arised, but you might encounter bugs
I haven't.

Locking items with particles work with Quest avatars, but it still
pretty limited.
If you don't want to have a "Very Poor" rated avatar, the limits are
200 polygons for Quest users, 2500 for PC users.

Locking items with constraints has no such limitations but only work
on PC at the moment.

# Requirements

* Unity
* VRChat Avatar SDK 3.0

# Download

See https://github.com/vr-voyage/vrchat-worldlock-autosetup/releases

# Install

* Either install [**ObjectWorldLocker-English-Default.unitypackage**](https://github.com/vr-voyage/vrchat-worldlock-autosetup/releases/download/v1.2/ObjectWorldLocker-English-Default.unitypackage)
  using the editor menu **Assets > Import Package... > Custom Package...**.

**OR**

* Copy the code of this repository inside the **Assets** of your SDK3 Avatar project.

# Items in the demo

* Avatar : Vケットちゃん１号  
  https://www.v-market.work/ec/items/656/detail/
  
* Item : Low poly (midi) keyboard  
  https://sketchfab.com/3d-models/low-poly-midi-keyboard-50040134cbfe4268a9af8b074bd24b15

# Usage

## Setup an avatar with one item locked using Particles

Works with PC and Quest avatars.

https://user-images.githubusercontent.com/84687350/128454218-0d64153f-094c-4279-8635-006793f7c4da.mov

* Add your avatar to the Scene root.
* For good measures, make sure that your avatar position and rotation are set to 0,0,0.
* Add the item to the Scene root.
* Move the added item where you'd like to see it spawned, in relation to your avatar.

* Open the setup window **Voyage > World Lock Setup - Particles (PC or Quest)**.
* Click on the 'RESET' button, at the upper left of that window.
* Drag your avatar and the item to setup from the **Hierarchy**, and drop them inside that window.
* Click on the 'APPLY' button, that should have appeared at the bottom of that window.

Once done, a new setup clone of the avatar will appear.

You can then upload the clone, and use it in-game to spawn the objects using the **Expression menu**.

https://user-images.githubusercontent.com/84687350/128454266-9a728bc1-1f2e-4f90-93c9-e9a5683ed453.mov

This new clone main menu will have two new buttons in its **Expression menu** :
* Spawn - Which allows you to spawn the actual item.
* Rotate - Which allows you to define the orientation of the spawned element.

All the animations, animators, materials and meshes will be copied into a specific folder, named :
"[Avatar name]-ParticlesLock-[YearMonthDay]-[HourMinSeconds]-[Milliseconds]".
You can define where the folder is generated by dropping a folder on "Save Dir".

> You can actually drop a saved asset on "Save Dir".
> If you do so, "Save Dir" will be set to that asset folder.

Note :
- Due to how the Particle Emitter works,
  the orientation of the spawned item ignores the orientation of the
  avatar.  
  That means that spawned item will always have the same orientation.  
  This is why, to change the spawned orientation, a "Rotate" button
  was added.
- At best, Quest avatars will see their rating drop to **Poor** when
  using a Particle Emitter.  
  If the spawned item has more than 200 (two hundred) polygons,
  the rating will automatically downgrade to **Very Poor**.  
  You should take this seriously when it comes to Quest Avatars,
  since Quest clients are setup to always display "Fallback" avatars
  instead of **Very Poor** rated avatars.  
  Meaning that other users won't see your setup avatar unless they
  manually choose "Show avatar".
- You can only use ONE material to define the look of the spawned item.
  Note that, weirdly enough, you CANNOT use Particles shaders with
  Particles systems on Quest avatars.  
  Which means : No transparency.

## Setup an avatar with items locked using Constraints

Works with PC avatars only.
**Constraints** components are not allowed on Quest avatars.

https://user-images.githubusercontent.com/84687350/128454290-41b096f6-5657-4ec5-a816-60d50565aba4.mov

* Add your avatar to the Scene root.
* For good measures, make sure that your avatar position and rotation
  are set to 0,0,0.
* Add the items to the Scene root.
* Set the rotation and position of the items, in relation to your
  avatar, to define how it should appear when shown.
* The **Expression menu** buttons will show the item names as set
  in the **Hierarchy**.  
  So, set those names accordingly.

* Open the setup window
  **Voyage > World Lock Setup - Constraints (PC)**.
* Click on the 'RESET' button, at the upper left of that window.
* Drag your avatar and the item to setup from the **Hierarchy**,
  and drop them inside that window.
* Click on the 'APPLY' button, that should have appeared at the
  bottom of that window.

You can then upload the clone, and use it in-game to spawn the
items you just setup.

https://user-images.githubusercontent.com/84687350/128454320-78cb2eb1-1556-4a7e-888d-b442904e48ae.mov

This new clone will have a new submenu "World Objects" added to
its **Expressions menu**.
This menu contains Toggle buttons allowing you to spawn each
individual object.  

Note:
- You can setup up to 8 individual items (Only 8 items for now,
  due to menu creation limitations).
- The object orientation is relative to player orientation
  spawning it.  
  Since the object is then locked, the base rotation won't change
  until you spawn it again.

### Setup the items to always show at a specific world position

Follow **Setup an avatar with items locked using Constraints**,
but before clicking on 'APPLY' in the setup window, check
the box **Lock from world (0,0,0)**.  
By doing so, the avatar will be setup so that the items always
spawn at specific world coordinates.

These coordinates being the "Position" of these items, in the
Editor, before clicking on 'APPLY'.

That means that you can setup a **World Overlay** using this
mechanism.
  
# Licence
MIT

Meaning that, yes, You are free to incorporate this tool,
or parts of it, into other commercial goods, open source projects, ...

# 使い所

普段、アバターに着けているアイテムは、アバターと共に移動します。  
それでも、そのアイテムは出した後から、アバターと移動しないように設定出来ます。

そういうアバターと共に移動しない、ワールドに固定されているようなアイテムは、
「ワールド固定アイテム」と呼んでいます。

アイテムを「ワールド固定アイテム」に変化するように、
そしてExpressions Menuから、そのアイテム配置と収納できるように、
二つの自動設定ツールを配布しています。
各ツールは別の方法でアバターとアイテムを設けます。
各方法はそれぞれのメリットとデメリットがあります。

# 依存

* Unity
* VRChat Avatar SDK 3.0

# インストール方法

* [**ObjectWorldLocker-Japanese-Default.unitypackage**](https://github.com/vr-voyage/vrchat-worldlock-autosetup/releases/download/v1.2/ObjectWorldLocker-Japanese-Default.unitypackage)のファイルをダウンロードして
* Unityの「**Assets > Import Package... > Custom Package...**」メニューアイテムを押下して、
* ダウンロードしたファイルを開いた画面から開けてください。

# 使い方

二つのツールの基本使い方は簡単です：  
「画面でアバターとアイテムを決めて、適用のボタンを押下する」。

ボタンを押した後、アバターのワールド固定アイテムを出せるコピーが生成さます。

そのコピーをアップロードした後、ゲーム内で着せたら、  
Expressions Menuから、設置したアイテムを配置・収納できます。  
配置しているアイテムは、ワールドに固定されているように、移動しません。

## Particle Systemでアイテムを固定する機能をアバターに追加する

### 説明動画

[![Particlesの自動設定ツールの使い方](https://img.youtube.com/vi/4kGonrsPCVg/0.jpg)](https://www.youtube.com/watch?v=4kGonrsPCVg)

### 手順

PCとQuestアバター対応

* まずは、Sceneの中にSDK3.0のアバターを用意します。
* アイテムの配置場所がズレないように、
  アバターのPositionとRotationをゼロにします。
* 後は、Sceneに固定したいアイテムを追加します。
* アバターを基準として、アイテムのPositionを決めます。
* メニューバーで「Voyage > World Lock Setup - Particles (PC or Quest)」を押下して、
  自動設定画面を開きます。
* 画面の左上にある「リセット」ボタンを押します。
* Hierarchyからアバターとアイテムをドラッグして、その画面の上にドロップします。
* 画面の下に現れた「適用」ボタンを押します。

すると、アバターの設定されているコピーが、Sceneに追加されます。  
そのコピーをアップロードしたら、ゲーム内で、アイテムをワールドで召喚できます。  
召喚したアイテムは、削除するまで、動きません。

そのためにExpressionsメニューで、二つのボタンが追加されます：
* Spawn - アイテムを召喚・削除するボタン。
* Rotate - アイテムの方向を決めるボタン。

> 回転度を変わると、配置場所がリセットされます。

> アバターの方向を替えっても、召喚するアイテムの方向が変わりません。  
> パーティクルで配置されているアイテムの方向は
> 「Rotate」ボタンで決めます。

## Constraintsでアイテムを固定する機能をアバターに追加する

### 説明動画

[![Constraintsの自動設定ツールの使い方](https://img.youtube.com/vi/hpTEYyTml0o/0.jpg)](https://www.youtube.com/watch?v=hpTEYyTml0o)

### 手順

PCアバター対応
「Constraint」のコンポネントはQuest対応アバターで使えません。

* まずは、Sceneの中にSDK3.0のアバターを用意します。
* アイテムの配置場所がズレないように、
  アバターのPositionとRotationをゼロにします。
* 後は、Sceneに固定したいアイテムを追加します。
* アバターを基準として、アイテムのPositionとRotationを決めます。
* 後は、メニューバーで「Voyage > World Lock Setup - Constraints (PC)」を押下して、
  自動設定ツールの画面を開きます。
* 画面の左上にある「リセット」ボタンを押します。
* Hierarchyからアバターとアイテムをドラッグして、その画面の上にドロップします。
* 画面の下に現れた「適用」ボタンを押します。

すると、アバターの設定されているコピーが、Sceneに追加されます。。  
アップロードしたら、ゲーム内でそのコピーを使って、アイテムをワールドに配置できます。  
配置したアイテムは、収納されるまで、移動しません。

そのために、Expressionsメニューで、「World Objects」と言うサブメニューが追加されます。  
そこで、各アイテムを出すためのボタンがあります。  
ボタンを押下すると、関連のアイテムを配置します。  
もう一度押下すると、そのアイテムを収納します。

# メリット・デメリット

## Particle System

* **+** Questでも使えます。
* **-** QuestのアバターのRatingがPoorになります、必ず。
* **-** Questのアバターで200個のポリゴン以上の物を召喚すると、RatingがVery poorになって、相手がShow Avatarしないと、ロボットのアバターしか見えなくなります。
* **-** パーティクル・システムのレンダラーは一個のマテリアルしか使えませんから、召喚したい物の見た目を一個のマテリアルで決めなければなりません。
* **-** Questのアバターで、意外と、Particles SystemはParticlesのシェイダーを使えません。ですので、透明化はできません。

## Constraints (束縛)

* **-** PC Only
* **+** Ratingを低下しません。
* **+** アバターの一部ですから、アバターが使えるComponentをアイテムに付けられます　(音楽、アニメーション、…）。

# ワールド固定アイテムの設定方法

アイテムを「ワールド固定アイテム」にするように、二つの方法がありますね。

## Particle Emitter

一つは、  
アイテムを着けるより、  
Particle Emitterを着けて、  
そのParticleをアイテムに見えるように変化します。  
後は、そのParticleを動かないように設定すると、ワールド固定アイテムに見えます。

その方法はQuestアバターでも使えますが、Particle Emitterの重さのため、アバターのランキングがPoor以下になります。
そして、結局アイテムを着けていません。  
Particleがアイテムを化けていますね。  
そのため、コンポネントを着けることは不可能です。  
そして、マテリアルは一個しか使えません。  
つまり、メリットは一つだけです：Quest対応アバターでも使えます。

## 「Empty」と「Constraint」系のコンポネント

もう一つの方法は、複数の「Empty Object」を用意して、  
その「Empty Object」に「Constraint」コンポネントを着けて、  
そして、アイテムをその「Empty　Object」の子供にします。

「Constraint」コンポネントのお陰で、子供のアイテムをワールドに固定することができます。
その方法のデメリットは一つだけです：
「Constraint」のコンポネントをQuest対応アバターに着けることが出来ませんから、PCアバター・オンリーです。
逆に、メリットは多いんです。
まずは、そのComponentとEmptyはランキングを下がりません。
そして、アイテム自体がほぼ変わりませんから、
そのアイテムは「Contact Point」とか、「Animator」とか、「Audio Source」とか、
許可されるコンポネント全部が使えます。

## Stationsの整理方法

「VRC　Station」　(以下　「Station」、また　椅子）　は自動的に整理されています。
ですから、普通に使えますね。

整理の理由のやり方はこちらです：

「Station」のコンポネントを着けると、そのコンポネントは「Station Proxy」というオブジェクトに移動されます。
理由は、そのツールがアバターにワールド固定アイテムを設定すると、そのアイテムを配置するまで無効します。

VRChatでは、「Station」が着けているオブジェクトが無効になる後、その「Station」が壊れて、アバターをリロードするまで使えなくなります。
その問題を防ぐために、そのツールは「Station」が着けている部分を複製して、
普段無効にならないように、そのコピーをHierarchyの別の場所に移動します。
後は、そのコピーから、ColliderとStation以外のコンポネントを抜けて、
「Parent Constraint」を着けます。
そのコピーはいつも有効なりますが、着けているコンポネントが普段無効になります。
後は、アイテムを有効すると、そのコピーのコンポネントも有効になって、アイテムの「Station」にあった所に自動的に移動します。

## 不具合

### プレイヤーによってのズレ

（「ワールド原点から固定する」オプションを有効したら、その問題が発生しません）

含んだAnimationはアイテムの配置と固定を決めます。

つまり、リモート・プレイヤーの皆さんがアバターのAnimationを再生する後、そのプレイヤーのワールドで、アイテムが現れて、固定になります。
そのAnimationはアバターがロードされている後から再生できます。その前は不可能です。

周りのプレイヤーの皆さんが、そのアバターのAnimationを同じ所から再生すると、
そのアイテムは同じ所に現れますね。

逆に、アイテムを配置した後、アバターが移動したら、
そして新しいプレイヤーが来たら、
その「新しいプレイヤー」さんはアバターのAnimationを移動した場所から再生します。
結果は、アイテムが現れますが、他のプレイヤーと比べると、その配置の所がズレていることになります。

アイテムを再び収納・配置すると、そのズレがなくなるはずですが、
Animationが再生している場所が固定アイテムの位置に影響があることを忘れないでください。

# 質問

## 生成されたファイルの名前を替えることができますか？
はい、ファイルの名前を替えっていいです。

## 生成された名前を変化してよろしいですか？
はい、名前を替えってよろしいです。

## 生成されたコピーのメニューを編集できますか？
メニュー・アイテムの名前を替えっても平気です。
そのパラメータの名前を変わると、そのアイテムが動作出来なくなる可能性がありますから、ご遠慮ください。

## 新しいアイテムを追加するために、アバターのコピーをもう一度ツールで使うことはできますか
できません。  
新しいアイテムを追加したいなら、手順を元からやり直してください。  
そのツールはオリジナル・アバターと既に設定されているアバターを区別できません。  
そのせいで、既に設定されているアバターを、もう一度ツールで設定すると、AnimatorのParameterの名前が混ざって、問題が発生します。
